# CoderStew Website Production Deployment Guide

This guide covers deploying the CoderStew website to production with Docker containers, SSL certificates, and monitoring.

## üöÄ Quick Start

1. **Clone and prepare the repository:**
   ```bash
   git clone <repository-url>
   cd coderstew_website
   ```

2. **Configure production environment:**
   ```bash
   cp backend/.env.production backend/.env.production.local
   # Edit the .env.production.local file with your actual values
   ```

3. **Deploy to production:**
   ```bash
   ./deploy-production.sh
   ```

## üìã Prerequisites

### System Requirements
- **OS**: Linux (Ubuntu 20.04+ recommended)
- **Docker**: v20.10+
- **Docker Compose**: v2.0+
- **RAM**: 4GB minimum, 8GB recommended
- **Storage**: 50GB minimum, 100GB recommended
- **Network**: Static IP address or dynamic DNS

### Domain & DNS
- Domain name pointing to your server IP
- DNS A records configured:
  - `coderstew.com` ‚Üí Your server IP
  - `www.coderstew.com` ‚Üí Your server IP
  - `traefik.coderstew.com` ‚Üí Your server IP (optional)

### Firewall Configuration
- **Port 80**: HTTP (redirects to HTTPS)
- **Port 443**: HTTPS (SSL/TLS)
- **Port 22**: SSH (for management)
- All other ports should be blocked from external access

## ‚öôÔ∏è Configuration

### 1. Environment Variables

Edit `backend/.env.production` with your production values:

```bash
# Application
APP_KEY=base64:YOUR_32_CHARACTER_KEY
APP_URL=https://coderstew.com

# Database passwords (will be auto-generated if using deployment script)
DB_PASSWORD=your_secure_db_password

# Redis password
REDIS_PASSWORD=your_secure_redis_password

# Mail configuration
MAIL_USERNAME=your_smtp_username
MAIL_PASSWORD=your_smtp_password

# File storage (S3)
AWS_ACCESS_KEY_ID=your_aws_access_key
AWS_SECRET_ACCESS_KEY=your_aws_secret_key
AWS_BUCKET=your_s3_bucket_name

# Backup storage
BACKUP_S3_BUCKET=your_backup_bucket_name

# External services
MICROSOFT_CLIENT_ID=your_microsoft_client_id
MICROSOFT_CLIENT_SECRET=your_microsoft_client_secret
NEWSLETTER_API_KEY=your_newsletter_api_key
```

### 2. SSL Certificates

The deployment automatically handles SSL certificates via Let's Encrypt:

- **Production**: Automatic certificate generation and renewal
- **Staging**: Use `caServer: https://acme-staging-v02.api.letsencrypt.org/directory`
- **Local Dev**: Generate self-signed certificates with `./docker/traefik/generate-self-signed.sh`

### 3. Secrets Management

Database passwords are stored in separate files:
- `secrets/mysql_root_password.txt`
- `secrets/mysql_password.txt`

These are auto-generated by the deployment script with secure random values.

## üö¢ Deployment Process

### Automatic Deployment

Use the deployment script for a complete setup:

```bash
./deploy-production.sh
```

### Manual Deployment

1. **Create required networks:**
   ```bash
   docker network create traefik_public
   ```

2. **Build and start services:**
   ```bash
   docker compose -f docker-compose.prod.yml build
   docker compose -f docker-compose.prod.yml up -d
   ```

3. **Run Laravel setup:**
   ```bash
   docker compose -f docker-compose.prod.yml exec app php artisan migrate --force
   docker compose -f docker-compose.prod.yml exec app php artisan config:cache
   ```

### Service Architecture

The production deployment includes:

- **app**: Laravel application (PHP-FPM)
- **queue**: Laravel queue worker
- **scheduler**: Laravel task scheduler
- **web**: Nginx web server
- **db**: MySQL 8.0 database
- **redis**: Redis cache and sessions
- **traefik**: Reverse proxy with SSL termination
- **backup**: Automated backup service
- **prometheus**: Metrics collection
- **loki**: Log aggregation

## üìä Monitoring & Maintenance

### Service Status
```bash
# Check all services
docker compose -f docker-compose.prod.yml ps

# View logs
docker compose -f docker-compose.prod.yml logs -f

# Check specific service
docker compose -f docker-compose.prod.yml logs web
```

### Access Points

After successful deployment:

- **Website**: https://coderstew.com
- **Admin Panel**: https://coderstew.com/admin
- **API**: https://coderstew.com/api
- **Traefik Dashboard**: https://traefik.coderstew.com

### Health Monitoring

All services include health checks:
```bash
# Check health status
docker compose -f docker-compose.prod.yml ps

# Manual health check
curl -f https://coderstew.com/health
```

### Backups

Automated backups run daily at 2 AM:
- **Database**: Full MySQL dump
- **Storage**: Application files and logs  
- **Destination**: S3 bucket with 30-day retention
- **Encryption**: Data encrypted in transit and at rest

```bash
# Manual backup
docker compose -f docker-compose.prod.yml exec backup /usr/local/bin/backup.sh

# Backup health check
docker compose -f docker-compose.prod.yml exec backup /usr/local/bin/backup.sh health
```

## üîß Operations

### Updates

```bash
# Update application
./deploy-production.sh update

# Or manually:
git pull
docker compose -f docker-compose.prod.yml build --pull
docker compose -f docker-compose.prod.yml up -d
```

### Scaling

```bash
# Scale queue workers
docker compose -f docker-compose.prod.yml up -d --scale queue=3

# Scale web servers (requires load balancer)
docker compose -f docker-compose.prod.yml up -d --scale web=2
```

### Maintenance

```bash
# Stop services
./deploy-production.sh stop

# Restart services  
./deploy-production.sh restart

# View logs
./deploy-production.sh logs [service-name]
```

## üö® Troubleshooting

### Common Issues

1. **SSL Certificate Failures**
   - Check DNS resolution: `nslookup coderstew.com`
   - Verify firewall ports 80/443 are open
   - Check Let's Encrypt rate limits
   - Review Traefik logs: `docker compose logs traefik`

2. **Database Connection Issues**
   - Check MySQL container: `docker compose ps db`
   - Verify passwords in secrets files
   - Check database logs: `docker compose logs db`

3. **Application Errors**
   - Check Laravel logs: `docker compose logs app`
   - Verify environment configuration
   - Check file permissions in storage directories

4. **Performance Issues**
   - Monitor resource usage: `docker stats`
   - Check Redis memory: `docker compose exec redis redis-cli info memory`
   - Review slow query logs in MySQL

### Log Locations

- **Application**: `/var/www/html/storage/logs/`
- **Nginx**: `/var/log/nginx/`
- **MySQL**: `/var/log/mysql/`
- **Traefik**: `/var/log/traefik/`

### Recovery Procedures

1. **Database Recovery**
   ```bash
   # Restore from backup
   docker compose exec db mysql -u root -p < backup_file.sql
   ```

2. **Application Recovery**
   ```bash
   # Reset to known good state
   git reset --hard <commit-hash>
   docker compose build --no-cache
   docker compose up -d
   ```

3. **SSL Certificate Reset**
   ```bash
   # Remove certificates to force regeneration
   rm -rf docker/traefik/certs/acme.json
   docker compose restart traefik
   ```

## üìû Support

### Documentation Links
- [Traefik Documentation](https://doc.traefik.io/traefik/)
- [Laravel Documentation](https://laravel.com/docs)
- [Docker Documentation](https://docs.docker.com/)

### Monitoring Alerts
- Set up monitoring alerts for service failures
- Configure backup failure notifications
- Monitor SSL certificate expiration

### Maintenance Schedule
- **Daily**: Automated backups and log rotation
- **Weekly**: Security updates and dependency checks
- **Monthly**: Performance review and optimization
- **Quarterly**: Security audit and penetration testing

---

**‚ö†Ô∏è Security Reminder**: Keep all credentials secure, regularly update dependencies, and monitor logs for suspicious activity.